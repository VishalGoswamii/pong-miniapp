<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Mini Pong ‚Äî Farcaster Ready</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>

  <!-- Update these URLs to your deployed domain when you have one -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://example.com/og.png",
    "button":{
      "title":"Play Mini Pong",
      "action":{
        "type":"launch_frame",
        "name":"Mini Pong",
        "url":"https://example.com/",
        "splashImageUrl":"https://example.com/icon.png",
        "splashBackgroundColor":"#000000"
      }
    }
  }'/>
  <meta name="fc:frame" content='{
    "version":"1",
    "imageUrl":"https://example.com/og.png",
    "button":{
      "title":"Play Mini Pong",
      "action":{
        "type":"launch_frame",
        "name":"Mini Pong",
        "url":"https://example.com/",
        "splashImageUrl":"https://example.com/icon.png",
        "splashBackgroundColor":"#000000"
      }
    }
  }'/>

  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font:600 14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{position:fixed;inset:0;display:grid;place-items:center}
    canvas{width:min(100vw, 100vh);height:min(100vw, 100vh);display:block;background:#000}
    .scores{position:fixed;left:0;right:0;top:8px;display:flex;justify-content:space-between;padding:0 14%;pointer-events:none}
    .scores div{font:900 clamp(28px,7vw,56px)/1 system-ui; color:#fff}
    .hud{position:fixed;left:0;right:0;bottom:10px;text-align:center;color:#9aa0a6}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
    .card{background:#0b0b0b;border:1px solid #222;border-radius:12px;padding:16px;color:#eaeaea;width:min(92vw,420px)}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{appearance:none;background:#121826;border:1px solid #26324a;color:#cbd5e1;border-radius:10px;padding:10px 12px;font:700 14px/1 system-ui;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .ghost{background:transparent}
  </style>

  <!-- Safe to include; code handles absence gracefully -->
  <script defer src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk/dist/index.umd.js"></script>
</head>
<body>
  <div class="wrap">
    <canvas id="game" aria-label="Mini Pong"></canvas>
  </div>

  <div class="scores"><div id="scL">0</div><div id="scR">0</div></div>
  <div id="hud" class="hud"></div>

  <!-- Simple start/menu overlay (not shown during gameplay) -->
  <div id="overlay" class="overlay">
    <div class="card">
      <div style="font:900 22px system-ui;margin-bottom:4px">Mini Pong</div>
      <div style="opacity:.85;margin-bottom:12px">First to 11. Arrow keys or drag to move.</div>
      <div class="row">
        <button id="playBtn" class="btn">‚ñ∂ Start</button>
        <button id="againBtn" class="btn" style="display:none">‚ñ∂ Play Again</button>
        <button id="pauseBtn" class="btn ghost">‚èØ Pause/Resume</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addBtn" class="btn">‚ûï Add to Farcaster</button>
        <button id="shareBtn" class="btn">üì£ Share High Score</button>
        <button id="closeBtn" class="btn ghost">‚úï Close</button>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  /* --- Farcaster SDK (robust, optional) --- */
  let fc=null, readySent=false;
  function setupSDK(){
    if(window.FarcasterMiniApp && !fc){
      fc = new window.FarcasterMiniApp.MiniAppSDK();
      // do NOT call ready yet; call after first paint
      fc.context().catch(()=>{});
    }
  }
  document.addEventListener('DOMContentLoaded', setupSDK);
  function signalReadyOnce(){
    if(readySent) return;
    readySent = true;
    if(fc){ try{ fc.actions.ready(); }catch(e){} }
  }

  /* --- DOM --- */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
  const scL = document.getElementById('scL');
  const scR = document.getElementById('scR');
  const hud = document.getElementById('hud');
  const overlay = document.getElementById('overlay');
  const playBtn = document.getElementById('playBtn');
  const againBtn= document.getElementById('againBtn');
  const pauseBtn= document.getElementById('pauseBtn');
  const addBtn  = document.getElementById('addBtn');
  const shareBtn= document.getElementById('shareBtn');
  const closeBtn= document.getElementById('closeBtn');

  /* --- Config --- */
  const WIN=11;
  const FIXED_DT=1/60, MAX_ACCUM=0.25;
  const DPR_MIN=1, DPR_MAX=2;
  const BALL=10, SPEED_BALL=240, SPEED_AI=320, SPEED_PADDLE=380;

  let P_W=16, P_H=0, P_R=6, DOT_H=10, DOT_G=10;

  const state = {
    dpr:1, cssW:0, cssH:0, last:0, accum:0,
    lY:0, rY:0,
    scoreL:0, scoreR:0, rally:0,
    paused:true, gameover:false, counting:false, t0:0,
    balls:[]
  };

  function clamp(v,a,b){ return v<a?a : v>b?b : v; }

  function sizeCanvas(){
    const r=canvas.getBoundingClientRect();
    const dpr=clamp(window.devicePixelRatio||1, DPR_MIN, DPR_MAX);
    if(state.cssW===r.width && state.cssH===r.height && state.dpr===dpr) return;
    state.cssW=r.width|0; state.cssH=r.height|0; state.dpr=dpr;
    canvas.width=Math.max(1,Math.floor(state.cssW*dpr));
    canvas.height=Math.max(1,Math.floor(state.cssH*dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.imageSmoothingEnabled=false;

    P_W=Math.max(12, Math.round(state.cssW*0.018));
    P_H=Math.max(120, Math.round(state.cssH*0.45));
    P_R=Math.round(P_W*0.45);
    DOT_H=Math.max(8, Math.round(state.cssH*0.014));
    DOT_G=DOT_H;
  }

  function resetPositions(){
    state.lY=(state.cssH-P_H)/2;
    state.rY=(state.cssH-P_H)/2;
    spawnBall(Math.random()<0.5?-1:1);
  }

  function spawnBall(dir){
    const ay=clamp(Math.random()*2-1, -0.72, 0.72);
    const s=SPEED_BALL*(1+Math.min(0.012*state.rally,0.6));
    const vx=dir*s*Math.sqrt(1-ay*ay), vy=s*ay;
    state.balls=[{x:(state.cssW-BALL)/2, y:(state.cssH-BALL)/2, vx, vy}];
  }

  /* --- Sim --- */
  const keys={up:false,down:false}; let pointerY=null;

  function stepBall(b,dt){
    b.x+=b.vx*dt; b.y+=b.vy*dt;
    if(b.y<=0){ b.y=0; b.vy=Math.abs(b.vy); }
    else if(b.y+BALL>=state.cssH){ b.y=state.cssH-BALL; b.vy=-Math.abs(b.vy); }

    // left
    if(b.x<=P_W+12){
      if(b.y+BALL>=state.lY && b.y<=state.lY+P_H){
        b.x=P_W+12; b.vx=Math.abs(b.vx)*1.045;
        const rel=((b.y+BALL/2)-(state.lY+P_H/2))/(P_H/2);
        b.vy+=rel*95; state.rally++;
      }
    }
    // right
    const rx=state.cssW-(P_W+12)-BALL;
    if(b.x>=rx){
      if(b.y+BALL>=state.rY && b.y<=state.rY+P_H){
        b.x=rx; b.vx=-Math.abs(b.vx)*1.045;
        const rel=((b.y+BALL/2)-(state.rY+P_H/2))/(P_H/2);
        b.vy+=rel*95; state.rally++;
      }
    }

    // scoring
    if(b.x+BALL<0){
      state.scoreR++; state.rally=0; spawnBall(+1); state.counting=true; state.t0=performance.now(); checkWin();
    } else if(b.x>state.cssW){
      state.scoreL++; state.rally=0; spawnBall(-1); state.counting=true; state.t0=performance.now(); checkWin();
    }
  }

  function step(dt){
    if(state.gameover || state.paused) return;
    if(state.counting) return;

    if(keys.up) state.lY -= SPEED_PADDLE*dt;
    if(keys.down) state.lY += SPEED_PADDLE*dt;

    if(pointerY!=null){
      const rect=canvas.getBoundingClientRect();
      const y=(pointerY-rect.top)*(state.cssH/rect.height) - P_H/2;
      const dy=clamp(y,0,state.cssH-P_H) - state.lY;
      state.lY += clamp(dy, -SPEED_PADDLE*dt, SPEED_PADDLE*dt);
    }
    state.lY = clamp(state.lY, 0, state.cssH-P_H);

    // AI (simple, a touch imperfect)
    const b=state.balls[0];
    const target = b.y + BALL/2 - P_H/2 + Math.sin(performance.now()/260)*6;
    const dy = target - state.rY;
    state.rY = clamp(state.rY + clamp(dy, -SPEED_AI*dt, SPEED_AI*dt), 0, state.cssH-P_H);

    for(const ball of state.balls) stepBall(ball, dt);
  }

  function checkWin(){
    if(state.scoreL>=WIN || state.scoreR>=WIN){
      state.gameover=true;
      showOverlay('Game Over', `Final ${state.scoreL} ‚Äì ${state.scoreR}`);
      const hs=Number(localStorage.getItem('mini_high')||0);
      if(state.scoreL>hs) localStorage.setItem('mini_high', String(state.scoreL));
      againBtn.style.display='inline-block';
      playBtn.style.display='none';
      overlay.style.display='flex';
    }
  }

  /* --- Draw (simple retro look) --- */
  function roundedRect(x,y,w,h,r){
    const rr=Math.min(r,Math.min(w,h)/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function draw(){
    const w=state.cssW, h=state.cssH;

    // background & midline
    ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='rgba(255,255,255,.8)';
    const mid=(w/2|0)-1;
    for(let y=10;y<h-10;y+=DOT_H+DOT_G) ctx.fillRect(mid,y,2,DOT_H);

    // paddles
    ctx.save(); ctx.shadowColor='rgba(255,255,255,.25)'; ctx.shadowBlur=10; ctx.fillStyle='#fff';
    roundedRect(12, state.lY, P_W, P_H, P_R); ctx.fill();
    roundedRect(w-P_W-12, state.rY, P_W, P_H, P_R); ctx.fill();
    ctx.restore();

    // ball (square, retro)
    for(const b of state.balls){ ctx.fillStyle='#ffde8a'; ctx.fillRect(b.x,b.y,BALL,BALL); }

    // countdown
    if(state.counting){
      const el=(performance.now()-state.t0)/1000;
      const rem=Math.max(0,3-Math.floor(el));
      if(rem>0){
        ctx.font='900 72px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillStyle='#ffde8a'; ctx.globalAlpha=.95;
        const frac=1-(el%1), s=1+0.18*(1-frac);
        ctx.save(); ctx.translate(w/2,h/2); ctx.scale(s,s); ctx.fillText(String(rem),0,0); ctx.restore();
        ctx.globalAlpha=1;
      } else state.counting=false;
    }

    // HUD
    scL.textContent = String(state.scoreL);
    scR.textContent = String(state.scoreR);
    hud.textContent = state.gameover ? 'Game Over' : (state.paused ? 'Paused' : `Rally: ${state.rally}`);

    // notify Farcaster after first paint
    signalReadyOnce();
  }

  /* --- Loop --- */
  function loop(ts){
    if(!state.last) state.last=ts;
    let dt=(ts-state.last)/1000; state.last=ts;

    if(!state.paused && !state.gameover){
      state.accum=Math.min(MAX_ACCUM, state.accum+dt);
      while(state.accum>=FIXED_DT){ step(FIXED_DT); state.accum-=FIXED_DT; }
    }
    draw();
    requestAnimationFrame(loop);
  }

  /* --- Overlay + buttons --- */
  function showOverlay(title, sub){
    overlay.querySelector('.card div').textContent = title;
    overlay.style.display='flex';
  }

  playBtn.onclick = ()=>{
    overlay.style.display='none';
    state.paused=false; state.counting=true; state.t0=performance.now();
  };
  againBtn.onclick= ()=>{
    state.scoreL=0; state.scoreR=0; state.rally=0; state.gameover=false;
    resetPositions(); overlay.style.display='none';
    state.paused=false; state.counting=true; state.t0=performance.now();
  };
  pauseBtn.onclick= ()=>{
    if(state.gameover) return;
    state.paused=!state.paused;
    overlay.style.display = state.paused ? 'flex' : 'none';
  };
  closeBtn.onclick= ()=>{ overlay.style.display='flex'; };

  addBtn.onclick = async ()=>{
    if(fc){ try{ await fc.actions.addMiniApp(); return; }catch(e){} }
    window.open(location.origin,'_blank');
  };
  shareBtn.onclick = async ()=>{
    const hs=Number(localStorage.getItem('mini_high')||0);
    const text=`I just hit ${hs} in Mini Pong!`;
    if(fc){ try{ await fc.actions.composeCast({ text }); return; }catch(e){} }
    if(navigator.share){ try{ await navigator.share({ text }); return; }catch(e){} }
    try{ await navigator.clipboard.writeText(text); shareBtn.textContent='‚úÖ Copied!'; setTimeout(()=>shareBtn.textContent='üì£ Share High Score',1400);}catch(_){}
  };

  /* --- Input --- */
  function onKey(e){ const d=e.type==='keydown';
    if(e.key==='ArrowUp'||e.key==='w'||e.key==='W'){ keys.up=d; e.preventDefault(); }
    if(e.key==='ArrowDown'||e.key==='s'||e.key==='S'){ keys.down=d; e.preventDefault(); }
    if(e.key==='Escape'){ pauseBtn.click(); }
    if(e.key==='Enter' && overlay.style.display!=='none'){ playBtn.click(); }
  }
  window.addEventListener('keydown',onKey,{passive:false});
  window.addEventListener('keyup',onKey,{passive:false});
  let pointerY=null;
  canvas.addEventListener('pointerdown',e=>{ pointerY=e.clientY; },{passive:true});
  window.addEventListener('pointermove',e=>{ if(pointerY!=null) pointerY=e.clientY; },{passive:true});
  window.addEventListener('pointerup',()=>{ pointerY=null; },{passive:true});

  window.addEventListener('resize', sizeCanvas, {passive:true});
  document.addEventListener('visibilitychange', ()=>{ state.last=0; });

  /* --- Boot --- */
  function init(){
    sizeCanvas();
    resetPositions();
    // show menu initially
    overlay.style.display='flex';
    requestAnimationFrame(loop);
  }
  init();
})();
</script>
</body>
</html>
