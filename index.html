<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>PicklePong Mini</title>

  <style>
    :root{
      --text:#e6f1ff;
      --accent:#f5e04c;
      --btn-bg: rgba(245,224,76,.10);
      --btn-border: rgba(245,224,76,.65);
      --btn-bg-strong: rgba(245,224,76,.22);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%;margin:0;background:#070a10;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

    /* Router */
    .view{display:none}
    .homeWrap.view.show, .gameWrap.view.show, .page.view.show{display:flex}

    /* Mobile layout */
    .homeWrap{min-height:100dvh;flex-direction:column;align-items:center;justify-content:center;padding:16px 14px 28px;gap:10px}
    .gameWrap{min-height:100dvh;flex-direction:column}
    .page{min-height:100dvh;flex-direction:column}

    /* Buttons: big, stacked, thumb-friendly */
    .btn{
      display:block; width:min(92vw,520px);
      padding:14px 16px; margin:8px auto;
      border-radius:16px; font-weight:800; letter-spacing:.02em;
      background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--text);
      box-shadow:var(--shadow);
    }
    .btn.primary{ background:var(--btn-bg-strong) }
    .btn.chip{
      width:auto; padding:10px 12px; margin:0; border-radius:12px;
      display:inline-block; box-shadow:none;
    }

    /* Header (game, pages) */
    .bar{display:flex; align-items:center; gap:8px; flex-wrap:wrap; padding:10px 12px}
    .spacer{flex:1}

    /* Canvas / CRT */
    .crt{flex:1; display:grid; place-items:center; position:relative; padding:10px 12px 18px}
    canvas{
      width:min(94vw, 560px);
      height:auto; aspect-ratio:9/16;
      border-radius:20px; image-rendering:pixelated;
      border:2px solid #333;
      box-shadow:0 16px 40px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.03);
      background:#0b0f15; /* gets overdrawn by our court painter */
    }

    /* Countdown */
    .countdown{position:absolute; inset:10px 12px 18px; display:none; place-items:center; background:rgba(0,0,0,.55); border-radius:18px}
    .countdown.show{display:grid}
    .countNum{font-size:3.6rem; font-weight:1000; letter-spacing:.06em; color:var(--accent); text-shadow:0 0 18px rgba(245,224,76,.5)}

    /* Cards for settings/board */
    .card{margin:8px auto; width:min(92vw,560px); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px 12px; box-shadow:var(--shadow)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .list{margin:0; padding-left:18px}
  </style>
</head>
<body>
  <!-- ============== HOME (mobile-first, single-column buttons) ============== -->
  <div id="homePage" class="homeWrap view show">
    <main style="text-align:center;width:100%">
      <h1 style="margin:0 0 4px">üèì PicklePong</h1>
      <div style="opacity:.8;margin-bottom:8px">Mobile-only ‚Ä¢ Farcaster-friendly</div>

      <button id="playRegular" class="btn primary">‚ñ∂Ô∏è Play ‚Äî Regular</button>
      <button id="playArcade"  class="btn">‚ö° Play ‚Äî Arcade (Power-ups)</button>
      <button id="btnShare"    class="btn">üîó Share</button>
      <button id="btnSettings" class="btn">‚öôÔ∏è Settings</button>
      <button id="btnBoard"    class="btn">üèÜ Leaderboard</button>
    </main>
  </div>

  <!-- ============== GAME ============== -->
  <div id="gamePage" class="gameWrap view">
    <header class="bar">
      <button id="btnHome"  class="btn chip">üè† Home</button>
      <button id="btnPause" class="btn chip">‚è∏Ô∏è Pause</button>
      <button id="btnReset" class="btn chip">üîÑ Reset</button>
      <button id="btnTheme" class="btn chip" title="Toggle court theme">üé® Theme: Blue|Red</button>
      <span class="spacer"></span>
      <span id="modeTag"  class="btn chip" style="pointer-events:none"></span>
      <span id="score"    class="btn chip" style="pointer-events:none; min-width:60px; text-align:center"></span>
    </header>

    <div class="crt">
      <canvas id="game" width="540" height="960" aria-label="PicklePong game area" role="img"></canvas>
      <section id="countdown" class="countdown"><div id="countNum" class="countNum">3</div></section>
    </div>
  </div>

  <!-- ============== SETTINGS ============== -->
  <div id="settingsPage" class="page view" style="padding:10px 12px 24px">
    <header class="bar">
      <strong>Settings</strong>
      <span class="spacer"></span>
      <button id="backFromSettings" class="btn chip">‚¨ÖÔ∏è Back</button>
    </header>
    <main class="card">
      <div class="row" style="margin-bottom:10px">
        <label><b>Sound</b></label>
        <button id="toggleSound" class="btn chip">üîä On</button>
      </div>
      <div class="row">
        <label><b>Court Theme</b></label>
        <button id="setBlueRed" class="btn chip">Blue | Red</button>
        <button id="setRedBlue" class="btn chip">Red | Blue</button>
      </div>
      <div style="opacity:.7;margin-top:8px">Theme format is <i>Left | Right</i> ground color.</div>
    </main>
  </div>

  <!-- ============== LEADERBOARD ============== -->
  <div id="boardPage" class="page view" style="padding:10px 12px 24px">
    <header class="bar">
      <strong>Leaderboard</strong>
      <span class="spacer"></span>
      <button id="clearBoard" class="btn chip">üßπ Clear</button>
      <button id="backFromBoard" class="btn chip">‚¨ÖÔ∏è Back</button>
    </header>
    <main class="card">
      <ol id="boardList" class="list"></ol>
    </main>
  </div>

  <script>
  (function(){
    /* ===== Simple Router ===== */
    const views = {
      home: document.getElementById('homePage'),
      game: document.getElementById('gamePage'),
      settings: document.getElementById('settingsPage'),
      board: document.getElementById('boardPage')
    };
    function show(id){ Object.values(views).forEach(v=>v.classList.remove('show')); views[id].classList.add('show'); }

    /* ===== DOM ===== */
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    const scoreEl = document.getElementById('score');
    const modeTag = document.getElementById('modeTag');
    const countdown = document.getElementById('countdown');
    const countNum  = document.getElementById('countNum');
    const btnTheme  = document.getElementById('btnTheme');

    // Home
    document.getElementById('playRegular').onclick = ()=>{ mode='regular'; modeTag.textContent='REGULAR'; startGame(); };
    document.getElementById('playArcade').onclick  = ()=>{ mode='arcade';  modeTag.textContent='ARCADE';  startGame(); };
    document.getElementById('btnShare').onclick = async ()=>{
      try { if(navigator.share){ await navigator.share({ url: location.href, text: 'Play PicklePong Mini!' }); }
            else { await navigator.clipboard.writeText(location.href); alert('Link copied!'); } }
      catch(e){ try{ await navigator.clipboard.writeText(location.href); alert('Link copied!'); }catch{} }
    };
    document.getElementById('btnSettings').onclick = ()=> show('settings');
    document.getElementById('btnBoard').onclick    = ()=>{ renderBoard(); show('board'); };

    // Game header
    document.getElementById('btnHome').onclick  = ()=>{ running=false; show('home'); };
    document.getElementById('btnPause').onclick = ()=>{ if(!counting){ running=!running; } };
    document.getElementById('btnReset').onclick = ()=>{ if(!counting){ playerScore=cpuScore=0; resetBall(); running=false; startCountdown(()=>{ running=true; }); } };
    btnTheme.onclick = ()=>{
      themeLR = (themeLR==='blue|red') ? 'red|blue' : 'blue|red';
      btnTheme.textContent = 'üé® Theme: ' + (themeLR==='blue|red'?'Blue|Red':'Red|Blue');
      saveSettings();
    };

    // Settings page
    document.getElementById('backFromSettings').onclick = ()=> show('home');
    const toggleSoundBtn = document.getElementById('toggleSound');
    toggleSoundBtn.onclick = ()=>{ settings.sound=!settings.sound; syncSettingsUI(); saveSettings(); };
    document.getElementById('setBlueRed').onclick = ()=>{ themeLR='blue|red';  btnTheme.textContent='üé® Theme: Blue|Red'; saveSettings(); };
    document.getElementById('setRedBlue').onclick = ()=>{ themeLR='red|blue';   btnTheme.textContent='üé® Theme: Red|Blue'; saveSettings(); };

    // Board page
    document.getElementById('clearBoard').onclick = ()=>{ localStorage.removeItem('pp_board'); board.length=0; renderBoard(); };
    document.getElementById('backFromBoard').onclick = ()=> show('home');

    /* ===== Settings / Persistence ===== */
    const saved = JSON.parse(localStorage.getItem('pp_settings')||'{}');
    const settings = { sound: saved.sound !== undefined ? saved.sound : true };
    let themeLR = saved.themeLR || 'blue|red'; // "left|right"
    function saveSettings(){ localStorage.setItem('pp_settings', JSON.stringify({ ...settings, themeLR })); }
    function syncSettingsUI(){ toggleSoundBtn.textContent = settings.sound ? 'üîä On' : 'üîà Off'; }
    syncSettingsUI(); btnTheme.textContent = 'üé® Theme: ' + (themeLR==='blue|red'?'Blue|Red':'Red|Blue');

    /* ===== Leaderboard ===== */
    const board = JSON.parse(localStorage.getItem('pp_board')||'[]');
    function storeScore(){ board.push({ ts:Date.now(), score:playerScore, mode }); localStorage.setItem('pp_board', JSON.stringify(board)); }
    function renderBoard(){
      const list=document.getElementById('boardList'); list.innerHTML='';
      const top=board.slice().sort((a,b)=>b.score-a.score).slice(0,10);
      if(!top.length){ list.innerHTML='<li>No scores yet ‚Äî play a round!</li>'; return; }
      top.forEach((r,i)=>{ const li=document.createElement('li'); const d=new Date(r.ts); li.textContent=`#${i+1}  ${r.score} ‚Äî ${r.mode.toUpperCase()} ‚Äî ${d.toLocaleDateString()} ${d.toLocaleTimeString()}`; list.appendChild(li); });
    }

    /* ===== Gameplay (mobile-first) ===== */
    const PADDLE_W=16, PADDLE_H0=120, BORDER=16;
    const player={x:BORDER+8, y:H/2-PADDLE_H0/2, w:PADDLE_W, h:PADDLE_H0};
    const cpu   ={x:W-(BORDER+8)-PADDLE_W, y:H/2-PADDLE_H0/2, w:PADDLE_W, h:PADDLE_H0};

    let running=false, counting=false, mode='regular';
    let playerScore=0, cpuScore=0;

    // Speed profile (mobile friendly: chill start, gradual ramp)
    const SPEED_BASE=1.9, SPEED_STEP=1.05, SPEED_MAX=5.8;
    let speed=SPEED_BASE;
    const ball={x:W/2,y:H/2,r:11,vx:SPEED_BASE*(Math.random()<.5?-1:1),vy:SPEED_BASE*0.35};

    // Sound (subtle/no-op on some mobile browsers)
    const BLIP='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=';
    const audio={ hit:new Audio(BLIP), wall:new Audio(BLIP), score:new Audio(BLIP) };
    function play(a){ if(settings.sound){ try{ a.currentTime=0; a.play(); }catch{} } }

    // Helpers
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const rand=(a,b)=>Math.random()*(b-a)+a;
    const randSign=()=>Math.random()<.5?-1:1;

    function resetBall(dir=randSign()){
      speed=SPEED_BASE; ball.x=W/2; ball.y=H/2;
      const ang=rand(-0.26,0.26);
      ball.vx=speed*dir*Math.cos(ang);
      ball.vy=speed*Math.sin(ang);
    }

    function paddleBounce(p){
      const rel=(ball.y-(p.y+p.h/2))/(p.h/2); // -1..1
      speed=Math.min(speed*SPEED_STEP, SPEED_MAX);
      const dir=(p===player?1:-1), ang=rel*0.7;
      ball.vx=speed*dir*Math.cos(ang);
      ball.vy=speed*Math.sin(ang);
      ball.x=(p===player)? p.x+p.w+ball.r+0.5 : p.x-ball.r-0.5;
      play(audio.hit);
    }

    function themeColors(){
      // returns left and right ground colors and line/fill accents
      const BLUE = { ground:'#1c3f82', light:'#2553aa' };
      const RED  = { ground:'#8b1c2a', light:'#b02a3a' };
      const left = themeLR==='blue|red' ? BLUE : RED;
      const right= themeLR==='blue|red' ? RED  : BLUE;
      return {
        left, right,
        line: 'rgba(255,255,255,.92)',
        paddleFill: 'rgba(255,255,255,.22)',
        border: '#ffffff'
      };
    }

    function drawCourtBackground(){
      const th = themeColors();
      // apron/background
      ctx.fillStyle='#0b0f15';
      ctx.fillRect(0,0,W,H);

      // full play area inside border
      const x = BORDER, y = BORDER, w = W-2*BORDER, h = H-2*BORDER;

      // left/right ground halves
      ctx.fillStyle = th.left.ground;  ctx.fillRect(x, y, w/2, h);
      ctx.fillStyle = th.right.ground; ctx.fillRect(x+w/2, y, w/2, h);

      // "kitchen" (non-volley zone) stripes near center to sell pickleball vibe
      // We'll draw slightly lighter strips touching the center line on both halves
      ctx.fillStyle = th.left.light;  ctx.fillRect(x, y + h*0.25, w/2, h*0.5);
      ctx.fillStyle = th.right.light; ctx.fillRect(x+w/2, y + h*0.25, w/2, h*0.5);

      // border
      ctx.lineWidth=3; ctx.strokeStyle=th.border;
      ctx.strokeRect(x, y, w, h);

      // center line (Pong style)
      ctx.setLineDash([10,14]); ctx.strokeStyle=th.line;
      ctx.beginPath(); ctx.moveTo(W/2, y); ctx.lineTo(W/2, y+h); ctx.stroke();
      ctx.setLineDash([]);
    }

    function update(){
      if(!running || counting) return;

      // Move ball
      ball.x+=ball.vx; ball.y+=ball.vy;

      // Walls (use border padding)
      if(ball.y-ball.r < BORDER){ ball.y=BORDER+ball.r; ball.vy*=-1; play(audio.wall); }
      if(ball.y+ball.r > H-BORDER){ ball.y=H-BORDER-ball.r; ball.vy*=-1; play(audio.wall); }

      // Paddles
      if(ball.x-ball.r < player.x+player.w && ball.y>player.y && ball.y<player.y+player.h){ paddleBounce(player); }
      if(ball.x+ball.r > cpu.x && ball.y>cpu.y && ball.y<cpu.y+cpu.h){ paddleBounce(cpu); }

      // Scoring
      if(ball.x < 0){ cpuScore++; play(audio.score); resetBall(1);  startCountdown(()=>{ running=true; }); }
      if(ball.x > W){ playerScore++; play(audio.score); resetBall(-1); startCountdown(()=>{ running=true; }); }

      // CPU AI: gentle follow + bias with ball vy; scales a bit with speed
      const target = ball.y - cpu.h/2 + clamp(ball.vy*10, -60, 60);
      const ease   = 0.05 + (speed - SPEED_BASE)*0.02;
      cpu.y += (target - cpu.y)*ease;
      cpu.y  = clamp(cpu.y, BORDER, H-BORDER-cpu.h);

      // Clamp player
      player.y = clamp(player.y, BORDER, H-BORDER-player.h);

      // HUD
      scoreEl.textContent = `${playerScore}:${cpuScore}`;
      // also color the canvas border to match theme split
      const th = themeColors();
      canvas.style.borderColor = th.border;
    }

    function draw(){
      drawCourtBackground();
      const th = themeColors();

      // paddles
      ctx.fillStyle = th.paddleFill;
      ctx.fillRect(player.x, player.y, player.w, player.h);
      ctx.fillRect(cpu.x,    cpu.y,    cpu.w,    cpu.h);

      // ball
      ctx.fillStyle = '#f5e04c';
      ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    }

    function loop(){ update(); draw(); requestAnimationFrame(loop); }
    requestAnimationFrame(loop);

    /* ===== Start/Countdown ===== */
    function startGame(){
      show('game');
      playerScore=cpuScore=0;
      player.y=H/2-PADDLE_H0/2; cpu.y=H/2-PADDLE_H0/2;
      resetBall();
      running=false;
      startCountdown(()=>{ running=true; });
    }

    function startCountdown(done){
      counting=true; running=false;
      let n=3;
      countNum.textContent=n;
      countdown.classList.add('show');
      const t=setInterval(()=>{
        n--;
        if(n>0){ countNum.textContent=n; }
        else {
          clearInterval(t);
          countNum.textContent='GO!';
          setTimeout(()=>{ countdown.classList.remove('show'); counting=false; done&&done(); }, 450);
        }
      }, 700);
    }

    /* ===== Input (touch-first) ===== */
    const ptrY = e => (e.touches? e.touches[0].clientY : e.clientY) - canvas.getBoundingClientRect().top;
    let dragging=false, oy=0, py=0;
    function startDrag(e){ dragging=true; oy=ptrY(e); py=player.y; }
    function moveDrag(e){ if(!dragging) return; player.y = py + (ptrY(e)-oy); }
    function endDrag(){ dragging=false; }

    canvas.addEventListener('touchstart', startDrag, {passive:true});
    canvas.addEventListener('touchmove',  moveDrag,  {passive:true});
    canvas.addEventListener('touchend',   endDrag,   {passive:true});
    canvas.addEventListener('mousedown',  startDrag);
    canvas.addEventListener('mousemove',  moveDrag);
    window.addEventListener('mouseup',    endDrag);

    // Minimal keyboard support (desktop testing)
    window.addEventListener('keydown', e=>{
      if(e.key==='ArrowUp')   player.y -= 28;
      if(e.key==='ArrowDown') player.y += 28;
      if(e.key===' ' && !counting) running = !running;
      if(e.key==='Escape'){ running=false; show('home'); }
    });
  })();
  </script>
</body>
</html>
