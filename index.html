<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>PicklePong Mini</title>

  <style>
    :root{ --court:#0fd976; --accent:#f5e04c; --text:#e6f1ff; }
    html,body{height:100%;margin:0;background:#070a10;color:var(--text);font-family:system-ui,sans-serif;}
    .view{display:none}
    .homeWrap.view.show, .gameWrap.view.show{display:flex}
    .homeWrap{min-height:100vh;flex-direction:column;align-items:center;justify-content:center}
    .gameWrap{min-height:100vh;flex-direction:column}
    .btn{border:1px solid var(--accent);background:rgba(245,224,76,.08);color:var(--text);padding:.65rem 1rem;border-radius:1rem;font-weight:800;cursor:pointer;}
    .btn.primary{background:rgba(245,224,76,.25)}
    .btn.ghost{border-color:var(--court);}
    .crt{flex:1;display:grid;place-items:center;position:relative}
    canvas{background:#0b0f15;border:1px solid var(--court);border-radius:22px;image-rendering:pixelated}
    .countdown{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55)}
    .countdown.show{display:grid}
    .countNum{font-size:4rem;font-weight:900;color:var(--accent)}
  </style>
</head>
<body>
  <div id="homePage" class="homeWrap view show">
    <main>
      <h1>üèì PicklePong</h1>
      <button id="playRegular" class="btn primary">‚ñ∂Ô∏è Play Regular</button>
      <button id="playArcade" class="btn ghost">‚ö° Play Arcade</button>
    </main>
  </div>

  <div id="gamePage" class="gameWrap view">
    <header style="padding:1rem;display:flex;gap:1rem;align-items:center">
      <button id="btnHome" class="btn">üè† Home</button>
      <button id="btnPause" class="btn">‚è∏Ô∏è Pause</button>
      <button id="btnReset" class="btn">üîÑ Reset</button>
      <span id="modeTag" style="margin-left:auto"></span>
      <span id="score"></span>
    </header>
    <div class="crt">
      <canvas id="game" width="480" height="720"></canvas>
      <section id="countdown" class="countdown"><div id="countNum" class="countNum">3</div></section>
    </div>
  </div>

  <script>
  (function(){
    const views={home:document.getElementById('homePage'),game:document.getElementById('gamePage')};
    function show(id){Object.values(views).forEach(v=>v.classList.remove('show'));views[id].classList.add('show');}

    const canvas=document.getElementById('game');
    const ctx=canvas.getContext('2d');
    const W=canvas.width,H=canvas.height;
    const scoreEl=document.getElementById('score');
    const modeTag=document.getElementById('modeTag');

    const PADDLE_W=14,PADDLE_H0=100;
    const player={x:20,y:H/2-PADDLE_H0/2,w:PADDLE_W,h:PADDLE_H0};
    const cpu={x:W-20-PADDLE_W,y:H/2-PADDLE_H0/2,w:PADDLE_W,h:PADDLE_H0};

    // Flags and state
    let running=false, counting=false, mode='regular';
    let playerScore=0, cpuScore=0;

    // Ball speed: slow base, gradual ramp, capped max
    const SPEED_BASE=2.0, SPEED_STEP=1.05, SPEED_MAX=6.0;
    let speed=SPEED_BASE;
    const ball={x:W/2,y:H/2,r:10,vx:SPEED_BASE*(Math.random()<.5?-1:1),vy:SPEED_BASE*0.4};

    function resetBall(dir=(Math.random()<.5?-1:1)){
      speed=SPEED_BASE;
      ball.x=W/2; ball.y=H/2;
      const ang=(Math.random()*.5-.25); // gentle spread
      ball.vx=speed*dir*Math.cos(ang);
      ball.vy=speed*Math.sin(ang);
    }

    function paddleBounce(p){
      const rel=(ball.y-(p.y+p.h/2))/(p.h/2); // -1..1
      speed=Math.min(speed*SPEED_STEP,SPEED_MAX);
      const dir=(p===player?1:-1);
      const ang=rel*0.7;
      ball.vx=speed*dir*Math.cos(ang);
      ball.vy=speed*Math.sin(ang);
      ball.x=(p===player)?p.x+p.w+ball.r+0.5:p.x-ball.r-0.5;
    }

    function update(){
      if(!running||counting) return; // freeze during countdown

      // Ball motion
      ball.x+=ball.vx; ball.y+=ball.vy;

      // Walls
      if(ball.y-ball.r<14){ ball.y=14+ball.r; ball.vy*=-1; }
      if(ball.y+ball.r>H-14){ ball.y=H-14-ball.r; ball.vy*=-1; }

      // Paddles
      if(ball.x-ball.r<player.x+player.w && ball.y>player.y && ball.y<player.y+player.h){ paddleBounce(player); }
      if(ball.x+ball.r>cpu.x && ball.y>cpu.y && ball.y<cpu.y+cpu.h){ paddleBounce(cpu); }

      // Scoring
      if(ball.x<0){ cpuScore++; resetBall(1); startCountdown(()=>{ running=true; }); }
      if(ball.x>W){ playerScore++; resetBall(-1); startCountdown(()=>{ running=true; }); }

      // CPU AI (eases to ball)
      const target=ball.y-cpu.h/2+Math.max(Math.min(ball.vy*10,60),-60);
      cpu.y=Math.max(14,Math.min(H-14-cpu.h, cpu.y+(target-cpu.y)*0.06));

      // Clamp player
      player.y=Math.max(14,Math.min(H-14-player.h, player.y));

      // HUD
      scoreEl.textContent=`${playerScore}:${cpuScore}`;
    }

    function draw(){
      ctx.clearRect(0,0,W,H);
      // Court border
      ctx.strokeStyle='rgba(15,217,118,.85)'; ctx.lineWidth=3;
      ctx.strokeRect(14,14,W-28,H-28);
      // Paddles
      ctx.fillStyle='rgba(15,217,118,.18)';
      ctx.fillRect(player.x,player.y,player.w,player.h);
      ctx.fillRect(cpu.x,cpu.y,cpu.w,cpu.h);
      // Ball
      ctx.fillStyle='#f5e04c'; ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
    }

    function loop(){ update(); draw(); requestAnimationFrame(loop); }
    requestAnimationFrame(loop);

    // Start flow
    function startGame(){
      show('game');
      playerScore=cpuScore=0;
      player.y=H/2-PADDLE_H0/2; cpu.y=H/2-PADDLE_H0/2;
      resetBall();
      running=false;                 // ensure stopped
      startCountdown(()=>{ running=true; }); // unfreeze after countdown
    }

    // 3‚Äì2‚Äì1 countdown with hard freeze
    function startCountdown(done){
      counting=true; running=false;  // hard stop during countdown
      let n=3;
      const cd=document.getElementById('countdown');
      const num=document.getElementById('countNum');
      cd.classList.add('show'); num.textContent=n;
      const t=setInterval(()=>{
        n--;
        if(n>0){ num.textContent=n; }
        else {
          clearInterval(t);
          num.textContent='GO!';
          setTimeout(()=>{ cd.classList.remove('show'); counting=false; done&&done(); }, 500);
        }
      }, 700);
    }

    // Buttons
    document.getElementById('playRegular').onclick=()=>{ mode='regular'; modeTag.textContent='REGULAR'; startGame(); };
    document.getElementById('playArcade').onclick =()=>{ mode='arcade';  modeTag.textContent='ARCADE';  startGame(); };
    document.getElementById('btnHome').onclick=()=>{ running=false; show('home'); };
    document.getElementById('btnPause').onclick=()=>{ if(!counting){ running=!running; } };
    document.getElementById('btnReset').onclick=()=>{ if(!counting){ playerScore=cpuScore=0; resetBall(); running=false; startCountdown(()=>{ running=true; }); } };

    // Drag control
    function ptrY(e){ return (e.touches?e.touches[0].clientY:e.clientY)-canvas.getBoundingClientRect().top; }
    let drag=false, oy=0, py=0;
    canvas.addEventListener('mousedown',e=>{ drag=true; oy=ptrY(e); py=player.y; });
    canvas.addEventListener('mousemove',e=>{ if(drag){ player.y=py+ptrY(e)-oy; } });
    window.addEventListener('mouseup',()=>drag=false);
    canvas.addEventListener('touchstart',e=>{ drag=true; oy=ptrY(e); py=player.y; },{passive:true});
    canvas.addEventListener('touchmove',e=>{ if(drag){ player.y=py+ptrY(e)-oy; } },{passive:true});
    canvas.addEventListener('touchend',()=>drag=false,{passive:true});

    // Keyboard
    window.addEventListener('keydown',e=>{
      if(e.key==='ArrowUp') player.y-=28;
      if(e.key==='ArrowDown') player.y+=28;
      if(e.key===' ') { if(!counting) running=!running; }
      if(e.key==='Escape'){ running=false; show('home'); }
    });
  })();
  </script>
</body>
</html>
